<!DOCTYPE html>
<html>
<head>
    <title>mdec</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.min.js" type="text/javascript" charset="utf-8"></script>

    <style type="text/css" media="screen">
html,
body {
  background-color: #222222;
  color: #d4f542;
  height: 100%;
  margin: 0;
  font-family: "Ubuntu Mono", Menlo, Consolas, monospace;
}

.mbox {
  display: flex;
  flex-flow: column;
  height: 100%;
}

.mbox .mrow {
}

.mbox .mrow.header {
  flex: 0 1 auto;
}

.mbox .mrow.header h1 {
  float: left;
  padding: 0.25em 0.25em 0 0.25em;
}
.mbox .mrow.header a {
  text-decoration: none;
  color: #d4f542;
}

.mbox .mrow.content {
  display: flex;
  flex-flow: column;
  flex: 1 1 auto;
  overflow-y: auto;
}

.mbox .mrow.footer {
  flex: 0 1 1em;
}

.editor-row {
  height:  100%;
  display: flex;
  flex-direction: row;
}

.editor-col {
  display: flex;
  flex: 1;
  flex-flow: column;
}

.editor-col h3 {
  text-align: center;
  font-size: 1em;
}

.editor-col .version {
  white-space: pre-wrap;
  font-size: 0.75em;
  text-align: center;
}

.editor {
  flex: 1;
}

</style>
</head>

<body>

<div class="mbox">
  <div class="mrow header">
    <h1><a href="https://github.com/mborgerson/mdec">mdec</a></h1>

    <div class="d-flex flex-wrap align-items-center h-100">
      <form class="col-12 col-lg-auto mb-2 mb-lg-0" method="post" action="" enctype="multipart/form-data" id="binform">
      <input type="file" class="form-control form-control-sm" id="file" name="file" />
      </form>

      <div class="dropdown" style="padding: 0 0.25em">
        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
          Settings
        </button>
        <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenuButton1">
          <li>
            <a href="#" class="dropdown-item service-checkbox-link" for="angr-checkbox">
              <input class="form-check-input service-checkbox" type="checkbox" data-value="angr-lifting" value="" id="angr-checkbox-lifting">
              angr-lifting
              <input class="form-check-input service-checkbox" type="checkbox" data-value="angr-decompile" value="" id="angr-checkbox-decompile" checked>
              angr-decompile
            </a>
          </li>
          <li>
            <a href="#" class="dropdown-item service-checkbox-link" for="binja-checkbox">
              <input class="form-check-input service-checkbox" type="checkbox" data-value="binja-decompile" value="" id="binja-checkbox-decompile" checked>
              BinNinja-decompile
            </a>
          </li>
          <li>
            <a href="#" class="dropdown-item service-checkbox-link" for="ghidra-checkbox">
              <input class="form-check-input service-checkbox" type="checkbox" data-value="ghidra-lifting" value="" id="ghidra-checkbox-lifting">
              Ghidra-lifting
              <input class="form-check-input service-checkbox" type="checkbox" data-value="ghidra-decompile" value="" id="ghidra-checkbox-decompile" checked>
              Ghidra-decompile
            </a>
          </li>
          <li>
            <a href="#" class="dropdown-item service-checkbox-link" for="hexrays-checkbox">
              <input class="form-check-input service-checkbox" type="checkbox" data-value="hexrays-decompile" value="" id="hexrays-checkbox-decompile" checked>
              Hex-Rays-decompile
            </a>
          </li>
          <li>
            <a href="#" class="dropdown-item service-checkbox-link" for="jeb-checkbox">
              <input class="form-check-input service-checkbox" type="checkbox" data-value="jeb" value="" id="jeb-checkbox">
              JEB
            </a>
          </li>
          <li>
            <a href="#" class="dropdown-item service-checkbox-link" for="r2dec-checkbox">
              <input class="form-check-input service-checkbox" type="checkbox" data-value="r2dec" value="" id="r2dec-checkbox">
              r2dec
            </a>
          </li>
          <li>
            <a href="#" class="dropdown-item service-checkbox-link" for="reko-checkbox">
              <input class="form-check-input service-checkbox" type="checkbox" data-value="reko-lifting" value="" id="reko-checkbox-lifting">
              Reko-lifting
              <input class="form-check-input service-checkbox" type="checkbox" data-value="reko-decompile" value="" id="reko-checkbox-decompile">
              Reko-decompile
            </a>
          </li>
          <li>
            <a href="#" class="dropdown-item service-checkbox-link" for="retdec-checkbox">
              <input class="form-check-input service-checkbox" type="checkbox" data-value="retdec-lifting" value="" id="retdec-checkbox-lifting">
              RetDec-lifting
              <input class="form-check-input service-checkbox" type="checkbox" data-value="retdec-decompile" value="" id="retdec-checkbox-decompile">
              RetDec-decompile
           </a>
          </li>
          <li>
            <a href="#" class="dropdown-item service-checkbox-link" for="snowman-checkbox">
              <input class="form-check-input service-checkbox" type="checkbox" data-value="snowman-lifting" value="" id="snowman-checkbox-lifting">
              Snowman-lifting
              <input class="form-check-input service-checkbox" type="checkbox" data-value="snowman-decompile" value="" id="snowman-checkbox-decompile">
              Snowman-decompile
            </a>
          </li>
        </ul>
      </div>
    </div>

  </div>
  <div class="mrow content">

  <div class="editor-row">
    <div class="editor-col" id="angr-col"><h3>angr</h3><div class="version" id="angr-version"></div><div class="editor" id="angr-editor"></div></div>
    <div class="editor-col" id="binja-col"><h3>Binary Ninja</h3><div class="version" id="binja-version"></div><div class="editor" id="binja-editor"></div></div>
    <div class="editor-col" id="ghidra-col"><h3>Ghidra</h3><div class="version" id="ghidra-version"></div><div class="editor" id="ghidra-editor"></div></div>
    <div class="editor-col" id="hexrays-col"><h3>Hex-Rays</h3><div class="version" id="hexrays-version"></div><div class="editor" id="hexrays-editor"></div></div>
    <div class="editor-col" id="jeb-col"><h3>JEB</h3><div class="version" id="jeb-version"></div><div class="editor" id="jeb-editor"></div></div>
    <div class="editor-col" id="r2dec-col"><h3>r2dec</h3><div class="version" id="r2dec-version"></div><div class="editor" id="r2dec-editor"></div></div>
    <div class="editor-col" id="reko-col"><h3>Reko</h3><div class="version" id="reko-version"></div><div class="editor" id="reko-editor"></div></div>
    <div class="editor-col" id="retdec-col"><h3>RetDec</h3><div class="version" id="retdec-version"></div><div class="editor" id="retdec-editor"></div></div>
    <div class="editor-col" id="snowman-col"><h3>Snowman</h3><div class="version" id="snowman-version"></div><div class="editor" id="snowman-editor"></div></div>
  </div>
  </div>
<!--
  <div class="mrow footer">
    https://github.com/mborgerson/mdec
  </div>
 -->
</div>


<script type="text/javascript">

    var services = ['angr', 'binja', 'ghidra', 'hexrays', 'jeb', 'r2dec', 'reko', 'retdec', 'snowman'];
    var editors = {};
    var version_boxes = {};
    var options = [];

    function update_window_title() {
      var file = $('#file')[0].files[0];
      if (file == undefined) {
        document.title = 'mdec';
      } else {
        document.title = 'mdec: ' + file.name;
      }
    }

    function request_for_service(service) {
      var fd = new FormData();
      var file = $('#file')[0].files[0];
      var [svc, req] = service.split('-');
      if (file == undefined) return;
      fd.append('file', file);
      $.ajax({
          url: '/'+svc+'/version',
          type: 'get',
          success: function(response){
            version_boxes[svc].text(response);
          }
      })
      $.ajax({
          url: '/'+svc+'/'+req,
          type: 'post',
          data: fd,
          contentType: false,
          processData: false,
          beforeSend: function(jqxhr, settings){
              let msg = "Loading "+svc+" for " +req+"...";
              console.log(msg);
              editors[svc].setValue(msg, -1);
          },
          success: function(response){
              editors[svc].setValue(response, -1);
          },
          error: function(response){
              editors[svc].setValue("Error", -1);
          }
      });
    }

    function show_or_hide_col_for_checkbox(chk) {
      let svc = chk.attr('data-value');
      let col = $('#' + svc.split('-')[0] + '-col');
      if (chk.is(':checked')) {
        col.show();
        request_for_service(svc);
      } else {
        col.hide();
      }
    }

    $('.service-checkbox').click(function(event) {
      event.stopPropagation();
    });

    $('.service-checkbox').change(function() {
        let link = $(this).parent();
        var self = $(this).attr('id');
        link.children().each(function(){
            if($(this).attr('id') === self) {
                return;
            } else {
                $(this).prop('checked', false);
            }
        });
      show_or_hide_col_for_checkbox($(this));
    });

    ace.config.set('basePath', 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/');
    for (let i = 0; i < services.length; i++) {
      let svc = services[i];
      var editor = ace.edit(svc + "-editor");
      editor.setTheme("ace/theme/chaos");
      editor.setFontSize(18);
      editor.session.setMode("ace/mode/c_cpp");
      editors[svc] = editor;
      version_boxes[svc] = $('#' + svc + "-version");
    }

    $(document).ready(function() {
      update_window_title();
      $('.service-checkbox').each(function() {
        show_or_hide_col_for_checkbox($(this));
      });

      $("#file").change(function() {
        update_window_title();
        $(':checked').each(function(){
            let svc = $(this).attr('data-value');
            request_for_service(svc);
        });
      });
    });
</script>

</body>
</html>
